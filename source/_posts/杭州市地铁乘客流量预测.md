---
title: 杭州市地铁乘客流量预测
date: 2019-05-28 09:57:12
tags: [数据分析,Python,机器学习,天池竞赛]
categories:
- 机器学习
- 实战项目
- 天池竞赛
comments: true
---

天池竞赛城市计算AI挑战赛以“杭州市地铁乘客流量预测”为题，提供了杭州市2019年1月1日到25日的地铁刷卡流量数据，要求预测出未来时间的客流变化情况

# 赛题简介
赛题提供了以下文件
* Metro_train.zip，包含25天的刷卡数据，每天为一个单独的.csv文件
* testA_record_2019-01-28.csv，测试集，用来测试模型性能
* Metro_roadMap.csv，各地铁站点连接关系

刷卡数据格式为

|列名|类型|说明|示例|
|:-|:-|:-|:-|
|time|String|刷卡发生时间|2019-01-02 00:30:53|
|lineID|String|地铁线路ID|C|
|stationID|int|地铁站ID|15|
|deviceID|int|刷卡设备ID|2992|
|status|int|进出站状态，0表示出站，1表示进站|1|
|userID|String|用户ID|C21b87e232a083b3e7d6d45e2ff933e31|
|payType|int|刷卡类型|0|

Metro_roadMap.csv文件中是一个2维矩阵，首行和首列是地铁站ID，roadMap[i][j]为1表示stationID为i的地铁站和为j的地铁站相连，为0表示不相连

# 数据分析
## 初步分析
使用pandas对数据做一个初步分析
### 整体情况
首先读取一个数据文件，查看结构
```python
>>> data = pd.read_csv(path+'/record_2019-01-01.csv')
>>> data.head()
                    time lineID  stationID  deviceID  status                             userID  payType
0  2019-01-01 02:00:05      B         27      1354       0  D13f76f42c9a677c4add94d9e480fb5c5        3
1  2019-01-01 02:01:40      B          5       200       1  D9a337d37d9512184b8e3fd477934b293        3
2  2019-01-01 02:01:53      B          5       247       0  Dc9e179298617f40b782490c1f3e2346c        3
3  2019-01-01 02:02:38      B          5       235       0  D9a337d37d9512184b8e3fd477934b293        3
4  2019-01-01 02:03:42      B         23      1198       0  Dd1cde61886c23fdb7ef1fdb76c9b1234        3
>>>
```
可以看到，文件结构与描述一致，从左到右，列依次为time、lineID、stationID、deviceID、status、userID和payType

```python
>>> data.info()
<class 'pandas.core.frame.DataFrame'>
RangeIndex: 2539592 entries, 0 to 2539591
Data columns (total 7 columns):
time         object
lineID       object
stationID    int64
deviceID     int64
status       int64
userID       object
payType      int64
dtypes: int64(4), object(3)
memory usage: 106.6+ MB
>>>
```
除了首行，数据共2539592条，占用106MB内存

查看描述信息
```python
>>> data.describe()
          stationID      deviceID        status       payType
count  2.539592e+06  2.539592e+06  2.539592e+06  2.539592e+06
mean   2.885803e+01  1.395870e+03  5.002957e-01  1.432034e+00
std    2.190865e+01  1.002121e+03  5.000000e-01  8.313080e-01
min    0.000000e+00  0.000000e+00  0.000000e+00  0.000000e+00
25%    1.100000e+01  5.890000e+02  0.000000e+00  1.000000e+00
50%    2.000000e+01  1.056000e+03  1.000000e+00  1.000000e+00
75%    4.600000e+01  2.196000e+03  1.000000e+00  2.000000e+00
max    8.000000e+01  3.638000e+03  1.000000e+00  3.000000e+00
>>>
```
由描述信息可看出
* 共有253万次刷卡数据
* 地铁站ID从0到80，共81条地铁线
* 刷卡设备ID从0到3638，共3639个刷卡设备
* payType从0到3，共4种刷卡方式

### 基本统计
查看地铁线路统计信息
```python
>>> data.lineID.nunique()
3
>>> data.lineID.value_counts()
B    1677014
C     646253
A     216325
Name: lineID, dtype: int64
>>>
```
共3条地铁线，分别为A、B、C，其中地铁线路B流量最大为167万，C次之为64万，A最小为21万

查看地铁站统计信息
```python
>>> data.stationID.value_counts()
15    357091
9     167448
7      85737
11     75760
10     72913
20     70824
8      64963
24     61774
22     53702
25     51652
33     51514
12     48386
4      45819
13     38674
14     36249
16     33507
29     33227
2      32289
51     31819
46     29982
38     29870
78     29496
57     29271
56     26974
6      26747
58     26328
76     24916
39     24714
63     24493
55     24465
       ...
61     19535
27     19339
62     19279
43     18252
50     18144
70     17751
41     17596
48     17528
34     17422
32     16166
67     15656
45     13837
66     13644
71     13590
73     13041
36     12786
1      12477
44     12349
40     10519
21     10488
79     10328
31     10033
17      9481
64      9176
75      7964
28      7939
35      7466
72      7223
80      6752
74      4642
>>>
```
站点15的流量最大，站点9次之

用户统计分析
```python
>>> user_counts = data.userID.value_counts()
>>> user_counts.shape
(916414,)
>>> user_counts[user_counts>10].shape
(1092,)
>>> user_counts[user_counts>5].shape
(46683,)
>>> user_counts[user_counts==4].shape
(241819,)
>>> user_counts[user_counts==2].shape
(613793,)
>>>
```
由用户统计分析可看出
* 总的地铁出行用户数为91万人
* 只有4.6万人刷卡次数超过5次，1万人刷卡次数超过10次，60万人刷卡次数为2，24万人刷卡次数为4次

### 挖掘规律
由以上基本分析可得出几个关键结论
* 从地铁线路来看，流量大小依次为B>C>A
* 从地铁站来看，15站点流量极高，9站点次之
* 从用户信息来看，大量用户刷卡次数在5次以下，其中66%的用户是单程

由以上结论，提出以下问题
* 为什么B线流量大？
* 为什么15站和9站流量大？
* 为什么单程用户流量大？单程的起始和终点集中在哪些线路和站点？往返用户占多少？

#### 为什么B线流量大？
猜测B线流量大，可能是因为B线站点数量多，B线存在交通枢纽站点，或者B线上某些站点周边覆盖人口密度大

查看各线路站点数
```python
>>> data[data.lineID=='A'].stationID.nunique()
14
>>> data[data.lineID=='B'].stationID.nunique()
34
>>> data[data.lineID=='C'].stationID.nunique()
32
>>>
```
可看到B线站点数量为34最多，C线32站，A线最少，只有14站

查看各地铁线站点流量情况
```python
>>> data[data.lineID=='A'].stationID.value_counts().describe()
count       14.000000
mean     15451.785714
std       7684.061288
min       4642.000000
25%       8555.000000
50%      14623.000000
75%      21201.000000
max      29496.000000
Name: stationID, dtype: float64
>>> data[data.lineID=='B'].stationID.value_counts().describe()
count        34.000000
mean      49323.941176
std       62542.487342
min        7939.000000
25%       21330.250000
50%       32758.000000
75%       53189.500000
max      357091.000000
Name: stationID, dtype: float64
>>> data[data.lineID=='C'].stationID.value_counts().describe()
count       32.000000
mean     20195.406250
std       6149.949336
min       7466.000000
25%      17501.500000
50%      20390.500000
75%      24472.000000
max      31819.000000
Name: stationID, dtype: float64
>>>
```
可看到地铁线A最大站点流量才2.9万，平均在1.5万；B线最大站点流量为35万，平均为4.9万；C线最大流量站点为3万，平均为2万；因此，B线大部分站点流量都较高，例如15站、9站等高流量站点，都属于B线，所以导致B线整体流量较大

#### 为什么15站和9站流量大？
仅仅从训练数据种，无法得出15站和9站的其他信息，站点流量大小很大程度上取决于其周边设施以及本站是否为换乘站

根据赛题给出的站点连接关系，总结出以下交汇点

|站点1|站点2|
|--|--|
|28|20|
|51|9|
|50|10|
|51|10|
|52|10|
|74|5|
|75|5|
|80|15|
|77|46|
|78|46|

根据站点交汇关系，以及各地铁线路的总站点数，再结合[杭州市地铁图](http://map.amap.com/subway/index.html?&3301)，可确定
* B线为1号线、C线为2号线，A线为4号线
* B线站点范围为0~33，其中0为湘湖，5为近江，10为凤起路，15为火车站，20为客运中心，27为下沙滨江，33为临平
* C线站点范围为34~66(54不存在)，其中34为朝阳，46为钱江路，51为凤起路
* A线站点范围为67~80，74为甬江路，75为城星路，77为江锦路，78为景芳

15站为火车站，由于刷卡数据为2019年1月份，临近春节，因此猜测15站流量大是因为春运流量
9站为龙翔桥，经百度地图查看，该站点临近西湖，且周边为商业繁华地带，而读取的数据文件是1月1日元旦，因此流量大

#### 为什么单程用户流量大？
查看单车用户集中在哪些站点
```python
>>> user_counts = data.userID.value_counts()
>>> oneway_users = user_counts[user_counts==2].index
>>> oneway_users
Index([u'Da777d480eb319974721ba1395276b9b9',
       u'Dbb272e5468e0f8f3119affa3548cb2d8',
       u'Ba5b3c0b2fdcc02009044e1745f786a40',
       u'B5be311471b553fa8a1dae68ae2e98e25',
       u'B5c8c3ea1fe6fdb0f70cc264a16a43349',
       u'Dde0d323a4dd433975277717c57525cef',
       u'B55870174fd27626952cb0960a679ba6c',
       u'Ddf91d65e630c39ac4705d1a9789b1dbd',
       u'B3487dabebed8c675e2d72fcaea059ce7',
       u'B775172740ccc61a1856568a09baaa9dc',
       ...
       u'Be838ec43cc032ee398531caa5fd82bdb',
       u'B54815c3bbb7135547c0407d252d1562f',
       u'B703db1dc0f0a9600d7929754ca79e600',
       u'B8fa611fb11119fe7ee4a11d79cd3f6b3',
       u'Dc989f13b188864668cc0e7d9347d946c',
       u'B8f8d236356b772eb4f143796334d2981',
       u'Be37e7163697a8caacdb938546306eec0',
       u'A55804f3d7bf1b47eee1f26e77f7f9acb',
       u'D117ad973c40f4e4a154604f382923fb7',
       u'B3ddd6a228d019312e7ce53fdb4476301'],
      dtype='object', length=613793)
>>>
>>> data[data.userID.isin(oneway_users)].stationID.value_counts()
15    262484
9      60701
7      50871
20     39773
11     37383
24     35208
25     30863
33     27761
10     26101
8      25608
12     20355
22     20302
13     20282
4      20269
2      15590
14     15152
6      14855
57     14303
29     14138
69     13598
58     13278
16     12770
56     12546
0      11686
55     11581
23     11572
3      11247
38     11134
63     10900
30     10876
       ...
37      8152
5       8107
49      7859
66      7252
32      7079
71      7005
41      6912
43      6901
50      6759
48      6652
47      6522
73      5871
76      5827
31      5712
1       5535
44      5437
36      5362
40      4943
77      4550
21      4493
45      4483
79      4348
64      3480
75      3114
28      3083
17      3045
72      2973
35      2867
80      2233
74      1705
Name: stationID, Length: 80, dtype: int64
>>>
```
单程用户613793人，那么总流量为613793*2=1227586次。单程流量集中在15、9、7、20、11、24、25，15为火车站，9为龙翔桥，7为客运站，20为客运中心，11为商圈和住宅中心，24、25是大学城，因此可判断单程流量主要是由于临近春运的各大车站出入人口，以及元旦假期的出入人口

## 可视化
编写代码，以天为单位，绘制总流量图
![回调上下文](杭州市地铁乘客流量预测/image/subway-flow-predict-01.png)
由上图可看出，总流量以周为单位，呈周期性变化，规律是周内工作日流量较高，周5到达峰值，周末降到峰谷(除了1月1日的元旦假期)
总的趋势是无论周内周日，随着时间临近春节，整体流量有上升趋势

以时刻为单位，绘制3条地铁线的某天实时流量图，发现所有周内情况与下图类似
![回调上下文](杭州市地铁乘客流量预测/image/subway-flow-predict-03.png)
整天的流量呈现双峰现象，分别集中在早8点和晚6点，是上下班流量

周末的流量与下图类似
![回调上下文](杭州市地铁乘客流量预测/image/subway-flow-predict-04.png)

1月1日元旦的流量图如下
![回调上下文](杭州市地铁乘客流量预测/image/subway-flow-predict-02.png)

### 周内分析
查看数据摘要
```python
>>> data = pd.read_csv(path+'record_2019-01-02.csv')
>>> data.describe()
          stationID      deviceID        status       payType
count  2.376462e+06  2.376462e+06  2.376462e+06  2.376462e+06
mean   3.282597e+01  1.574050e+03  4.998182e-01  1.371589e+00
std    2.340102e+01  1.069709e+03  5.000001e-01  8.458438e-01
min    0.000000e+00  0.000000e+00  0.000000e+00  0.000000e+00
25%    1.300000e+01  6.770000e+02  0.000000e+00  1.000000e+00
50%    2.600000e+01  1.315000e+03  0.000000e+00  1.000000e+00
75%    5.300000e+01  2.565000e+03  1.000000e+00  2.000000e+00
max    8.000000e+01  3.638000e+03  1.000000e+00  3.000000e+00
```
可看到1月2日总流量为2376462

```python
>>> user_counts = data.userID.value_counts()
>>> user_counts.shape
(764188,)
>>> user_counts[user_counts>4].shape
(45376,)
>>> user_counts[user_counts==2].shape
(394674,)
>>> user_counts[user_counts==4].shape
(315658,)
```
总刷卡人数为74万，刷卡数主要集中在单程和往返

查看单程车站分布
```python

```


# 模型选择和评估

# 预测结果
